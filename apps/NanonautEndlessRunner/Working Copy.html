<!DOCTYPE html>
<html>
<head>
<title>Nanonaut Action</title>
</head>
<body>
<script>
//Version 1.7.0
var changeLog = {
//1.7.0; Added multiple backgrounds
//1.6.1; Changed final distance totaling
//1.6.0; Added Music
//1.5.2; Adjusted Sprinting logic
//1.5.1; Fixed bug in drawing gameover 
//1.5.0; Nanonaut can sprint
//1.4.1; Reworked coins into gooditems
//1.4.0; Added High Score
//1.3.2; Reduced overall length of collision detection logic and setup
//1.3.1; Prevented coins from spawning on each other
//1.3; Added coins
//1.2.1; Changed the start and pause screen look
//1.2; Added start and pause screens
//1.1; Randimized Robot speed
}

//Ideas
var ideas = {
//Add "Levels" with different backgrouncs and/or enemies
//Add Difficulty
//Add highscore marker
//Animate converting coin counter
}

// CONSTANTS
var CANVAS_WIDTH = 800;
var CANVAS_HEIGHT = 600;
var NANONAUT_WIDTH = 181;
var NANONAUT_HEIGHT = 229;
var GROUND_Y = 540;
var NANONAUT_Y_ACCELERATION = 1;
var CONTROL_KEYCODE = 17;
var SPACE_KEYCODE = 32;
var P_KEYCODE = 80;
var S_KEYCODE = 83;
var NANONAUT_JUMP_SPEED = 20;
var NANONAUT_X_SPEED = 5;
var BACKGROUND_WIDTH = 1000;
var NANONAUT_NR_ANIMATION_FRAMES = 7;
var NANONAUT_ANIMATION_SPEED = 3;
var ROBOT_WIDTH = 141;
var ROBOT_HEIGHT = 139;
var ROBOT_ANIMATION_SPEED = 5;
var ROBOT_NR_ANIMATION_FRAMES = 9;
var ROBOT_X_SPEED = 4;
var MIN_DISTANCE_BETWEEN_ROBOTS = 400;
var MAX_DISTANCE_BETWEEN_ROBOTS = 1200;
var MAX_ACTIVE_ROBOTS = 3;
var SCREENSHAKE_RADIUS = 16;
var NANONAUT_MAX_HEALTH = 100;
var PLAY_GAME_MODE = 0;
var GAME_OVER_GAME_MODE = 1;
var START_GAME_MODE = 2;
var PAUSE_GAME_MODE = 3;
var COIN_HEIGHT = 48;
var COIN_WIDTH = 48;
var NUMBER_OF_COINS = 3;
var HEART_HEIGHT = 48;
var HEART_WIDTH = 48;
var NUMBER_OF_HEARTS = 1;
var HIGH_SCORE_HEIGHT = 60;

// SETUP
var canvas = document.createElement('canvas');
var c = canvas.getContext('2d');
canvas.width = CANVAS_WIDTH;
canvas.height = CANVAS_HEIGHT;
document.body.appendChild(canvas);

var nanonaut = {
image: addNewImage('images/animatedNanonaut.png')
};

var backgroundImage1 = addNewImage('images/background.png');
var backgroundImage2 = addNewImage('images/background2.png');
var bush1Image = addNewImage('images/bush1.png');
var bush2Image = addNewImage('images/bush2.png');
var robotImage = addNewImage('images/animatedRobot.png');

var backgroundImage = {
images: [backgroundImage1, backgroundImage2],
imageNumber: 1,
switching: false,
numberToSwitch: 0
};

var nanonautSpriteSheet = newSpriteSheet(5, NANONAUT_WIDTH, NANONAUT_HEIGHT, addNewImage('images/animatedNanonaut.png'));
var robotSpriteSheet = newSpriteSheet(3, ROBOT_WIDTH, ROBOT_HEIGHT, robotImage);
var nanonautCollisionRectangle = newCollisionRectange(60, 20, 50, 200);
var robotCollisionRectangle = newCollisionRectange(50, 20, 50, 100);

var robotData = [];

var nanonautX = CANVAS_WIDTH / 2;
var nanonautY = GROUND_Y - NANONAUT_HEIGHT;
var nanonautYSpeed = 0;
var nanonautIsInTheAir = false; 
var nanonautIsSprinting = false;
var nanonautSprintModifier = 1;
var nanonautDistance = (nanonautX - 400) / 100;
var totalNanonautDistance = 0;
var spaceKeyIsPressed = false;
var controlKeyIsPressed = false;
var pKeyIsPressed = false;
var sKeyIsPressed = false;
var nanonautFrameNr = 0;
var gameFrameCounter = 0;

var cameraX = nanonautX - 150;
var cameraY = 0;

var bushData = generateBushes();
var coins = new GoodItem('images/coin-small-N.png', COIN_HEIGHT, COIN_WIDTH, NUMBER_OF_COINS, 'coin')
var hearts = new GoodItem('images/heart.png', HEART_HEIGHT, HEART_WIDTH, NUMBER_OF_HEARTS, 'heart');


var screenshake = false;
var nanonautHealth = NANONAUT_MAX_HEALTH
var gameMode = START_GAME_MODE;

window.addEventListener('keydown', onKeyDown);
window.addEventListener('keyup', onKeyUp);
window.addEventListener('load', start);

function start() {
window.requestAnimationFrame(mainLoop);
}
function generateBushes() {
var generatedBushData = [];
var bushX = 0;
while (bushX < (2 * CANVAS_WIDTH)) {
var bushImage;
if (Math.random() >= 0.5) {
bushImage = bush1Image
} else {
bushImage = bush2Image
}
generatedBushData.push({
x: bushX,
y: 80 + Math.random() * 20,
image: bushImage
});
bushX += 150 + Math.random() * 200;
}
return generatedBushData;
}
function newCollisionRectange(recXOffset, recYOffset, recWidth, recHeight) {
var collisionRectangle = {
xOffset: recXOffset,
yOffset: recYOffset,
width: recWidth,
height: recHeight
}
return collisionRectangle
}
function addNewImage(newImageSrc) {
var newImage = new Image();
newImage.src = newImageSrc;
return newImage;
}
function newSpriteSheet (sheetNrFramesPerRow, sheetSpriteWidth, sheetSpriteHeight, sheetImage) {
var spriteSheet = {
nrFramesPerRow: sheetNrFramesPerRow,
spriteWidth: sheetSpriteWidth,
spriteHeight: sheetSpriteHeight,
image: sheetImage
}
return spriteSheet;
}
function retriveHighScore(type) {
var highScore = Number(localStorage.getItem('highScore'));
if (type === 'pixel') return 100 * highScore;
else return highScore;
}
function saveHighScore(highScore, name) {
localStorage.setItem('highScore', highScore);
localStorage.setItem('highScoreName', name);
}
function checkHighScore(score) {
var currentHighScore = retriveHighScore('meter') ?? 0;
if (score > currentHighScore) {
var highScoreName = prompt('You got a high score! Enter your name.');
saveHighScore(score, highScoreName);
}
}
function showHighScore(hignScoreX, highScoreY) {
var score = retriveHighScore('meter');
var name = localStorage.getItem('highScoreName') ?? 'Unknown';
c.clearRect(0, CANVAS_HEIGHT - HIGH_SCORE_HEIGHT, CANVAS_WIDTH, HIGH_SCORE_HEIGHT);
c.fillStyle = 'ForestGreen';
c.fillRect(0, CANVAS_HEIGHT - HIGH_SCORE_HEIGHT, CANVAS_WIDTH, HIGH_SCORE_HEIGHT);
c.fillStyle = 'black';
c.font = '50px sans-serif';
c.textAlign = 'start';
c.fillText('High Score: ' + name + ' ' + score + 'm', hignScoreX, highScoreY)
}
function GoodItem(itemImageToUse, itemHeight, itemWidth, maxNumberOfItems, itemClass) {
	var object = {};
	var itemData = [];
	var numberOfActiveItems = 0;
	var collectedItems = 0;
	var itemImage = addNewImage(itemImageToUse);
  
	object.generateItem = function() {
		var x = 1;
		if (itemClass === 'heart') x = 3;
		var generatedItemData = {
			x: cameraX + (x * CANVAS_WIDTH) + Math.random() * CANVAS_WIDTH,
			y: 120 + Math.random() * 200,
			image: itemImage
		};
		return generatedItemData;
	}

	object.refillItemArray = function() {
		while (numberOfActiveItems < maxNumberOfItems) {
			var newItem = object.generateItem();
			var overlap = checkItemOverlap(itemData, newItem, itemHeight, itemWidth);
			if (!overlap) {
				itemData.push(newItem);
				numberOfActiveItems++;
			}
		}
	}
	
	object.onCollect = function(itemClass) {
		if (itemClass === 'coin') {
			return Number(1);
		} else if (itemClass === 'heart') {
			nanonautHealth += 5;
			if (nanonautHealth > NANONAUT_MAX_HEALTH) nanonautHealth = NANONAUT_MAX_HEALTH;
			
		}
	}

	object.update = function() {
		var itemIndex = 0;
		while (itemIndex < itemData.length) {
			var doesNanonautCollectItem = doesItem1OverlapItem2(
				nanonautX + nanonautCollisionRectangle.xOffset,
				nanonautY + nanonautCollisionRectangle.yOffset,
				nanonautCollisionRectangle.width,
				nanonautCollisionRectangle.height,
				itemData[itemIndex].x,
				GROUND_Y - itemData[itemIndex].y,
				itemWidth,
				itemWidth);

			if (doesNanonautCollectItem || itemData[itemIndex].x < cameraX - itemWidth) {
				itemData.splice(itemIndex, 1);
				numberOfActiveItems--;
				if (doesNanonautCollectItem) collectedItems += object.onCollect(itemClass);
			} else { 
				itemIndex++
			}
		}
		object.refillItemArray()
	}
	
	object.getCollected = function(multiplier) {
		return collectedItems * multiplier;
	}
	
	object.draw = function(cameraXPos, cameraYPos) {
		for (var i = 0; i < itemData.length; i++) {
			c.drawImage(itemData[i].image, itemData[i].x - cameraXPos, GROUND_Y - itemData[i].y - cameraYPos);
		}
	}
	
	object.refillItemArray();
	return object;
}

// MAIN LOOP
function mainLoop() {
update();
draw();
window.requestAnimationFrame(mainLoop);
}

// PLAYER INPUT
function onKeyDown(event) {
if (event.keyCode === SPACE_KEYCODE) {
spaceKeyIsPressed = true;
} 
if (event.keyCode === P_KEYCODE && gameMode === PLAY_GAME_MODE) {
gameMode = PAUSE_GAME_MODE;
document.getElementById("gameMusic").pause();
} else if (event.keyCode === P_KEYCODE && gameMode !== PLAY_GAME_MODE && gameMode !== GAME_OVER_GAME_MODE) {
document.getElementById("gameMusic").play();
gameMode = 	PLAY_GAME_MODE;
} 
if (event.keyCode === CONTROL_KEYCODE) {
controlKeyIsPressed = true;
}
}

function onKeyUp(event) {
if (event.keyCode === SPACE_KEYCODE) {
spaceKeyIsPressed = false;
} 

if (event.keyCode === CONTROL_KEYCODE) {
controlKeyIsPressed = false;
}
}

// UPDATING
function update() {
if(gameMode != PLAY_GAME_MODE) return;
gameFrameCounter = gameFrameCounter + 1;

if (controlKeyIsPressed  && !nanonautIsInTheAir) {
nanonautIsSprinting = true;
} else if (!controlKeyIsPressed && !nanonautIsInTheAir) {
nanonautSprintModifier = 1;
nanonautIsSprinting = false;
}
if (nanonautIsSprinting) {
nanonautSprintModifier = 2;
}

nanonautX += NANONAUT_X_SPEED * nanonautSprintModifier;
nanonautDistance = (nanonautX - 400) / 100;
if (spaceKeyIsPressed && !nanonautIsInTheAir) {
nanonautYSpeed = -NANONAUT_JUMP_SPEED;
nanonautIsInTheAir = true;
}
if (backgroundImage.numberToSwitch === 0 && backgroundImage.switching) {
backgroundImage.switching = false;
}
if ((gameFrameCounter % 1500) === 0 && !backgroundImage.switching) {
backgroundImage.switching = true;
backgroundImage.numberToSwitch = 2;
if (backgroundImage.imageNumber < backgroundImage.images.length) {
backgroundImage.imageNumber++;
} else {
backgroundImage.imageNumber = 1;
}
}

// Update Nanonaut.
nanonautY = nanonautY + nanonautYSpeed;
nanonautYSpeed = nanonautYSpeed + NANONAUT_Y_ACCELERATION;
if (nanonautY > (GROUND_Y - NANONAUT_HEIGHT)) {
nanonautY = GROUND_Y - NANONAUT_HEIGHT;
nanonautYSpeed = 0; 
nanonautIsInTheAir = false;
}

// Update Animation
if ((gameFrameCounter % NANONAUT_ANIMATION_SPEED) === 0) {
nanonautFrameNr = nanonautFrameNr + 1;
if (nanonautFrameNr >= NANONAUT_NR_ANIMATION_FRAMES) {
nanonautFrameNr = 0;
}
}

// Update camera
cameraX = nanonautX - 150;

// Update Bushes
for (var i=0; i<bushData.length; i++) {
if ((bushData[i].x - cameraX) < -CANVAS_WIDTH) {
bushData[i].x += (2 * CANVAS_WIDTH) + 150;
}
}

// Update GoodItems
coins.update()
hearts.update()

// Update robots.
screenshake = false
var nanonautTouchedARobot = updateRobots();
if (nanonautTouchedARobot) {
screenshake = true
if (nanonautHealth > 0) nanonautHealth -= 1 * nanonautSprintModifier;
}

// Check if game is over
if (nanonautHealth <= 0) {
nanonautHealth = 0;
gameMode = GAME_OVER_GAME_MODE;
totalNanonautDistance = nanonautDistance + (coins.getCollected(3))
screenshake = false;
document.getElementById("gameMusic").pause();
document.getElementById("gameoverSoundEffect").play();
}
}

function updateRobots() {
// Move and animate robots and check collision with Nanonaut.
var nanonautTouchedARobot = false;
for (var i=0; i<robotData.length; i++) {
if (doesItem1OverlapItem2(
nanonautX + nanonautCollisionRectangle.xOffset,
nanonautY + nanonautCollisionRectangle.yOffset,
nanonautCollisionRectangle.width,
nanonautCollisionRectangle.height,
robotData[i].x + robotCollisionRectangle.xOffset,
robotData[i].y + robotCollisionRectangle.yOffset,
robotCollisionRectangle.width,
robotCollisionRectangle.height
)) {
nanonautTouchedARobot = true;
}
robotData[i].x -= robotData[i].xSpeed;
if ((gameFrameCounter % ROBOT_ANIMATION_SPEED) === 0) {
robotData[i].frameNr = robotData[i].frameNr + 1;
if (robotData[i].frameNr >= ROBOT_NR_ANIMATION_FRAMES) {
robotData[i].frameNr = 0;
}
}
}

// Remove robots that have gone off-screen.
var robotIndex = 0;
while (robotIndex < robotData.length) {
if (robotData[robotIndex].x < cameraX - ROBOT_WIDTH) {
robotData.splice(robotIndex, 1);
} else {
robotIndex += 1;
}
}

if (robotData.length < MAX_ACTIVE_ROBOTS) {
var lastRobotX = CANVAS_WIDTH;
if (robotData.length > 0) {
lastRobotX = robotData[robotData.length - 1].x
}
var newRobotX = lastRobotX + MIN_DISTANCE_BETWEEN_ROBOTS + (Math.random() * (MAX_DISTANCE_BETWEEN_ROBOTS - MIN_DISTANCE_BETWEEN_ROBOTS)) / nanonautSprintModifier;
robotData.push({
x: newRobotX,
y: GROUND_Y - ROBOT_HEIGHT,
frameNr: 0,
xSpeed: (2 + Math.random() * 4)
});
}

return nanonautTouchedARobot;
}

function doesItem1OverlapItem2AlongOneAxis(item1NearX, item1FarX, item2NearX, item2FarX) {
var item1OverlapsNearItem2Edge = (item1FarX >= item2NearX) && (item1FarX <= item2FarX);
var item1OverlapsFarItem2Edge = (item1NearX >= item2NearX) && (item1NearX <= item2FarX);
var item1OverlapsEntireItem2 = (item1NearX <= item2NearX) && (item1FarX >= item2FarX);
return item1OverlapsNearItem2Edge || item1OverlapsFarItem2Edge || item1OverlapsEntireItem2;
}
function doesItem1OverlapItem2(item1X, item1Y, item1Width, item1Height, item2X, item2Y, item2Width, item2Height) {
var item1OverlapsItem2OnXAxis = doesItem1OverlapItem2AlongOneAxis(
item1X,
item1X + item1Width,
item2X,
item2X + item2Width
);
var item1OverlapsItem2OnYAxis = doesItem1OverlapItem2AlongOneAxis(
item1Y,
item1Y + item1Height,
item2Y,
item2Y + item2Height
);
return item1OverlapsItem2OnXAxis && item1OverlapsItem2OnYAxis;
}
function checkItemOverlap(itemArray, itemToAdd, itemHeight, itemWidth) {
for (var i = 0; i < itemArray.length; i++) {
if (doesItem1OverlapItem2(
itemToAdd.x,
GROUND_Y - itemToAdd.y,
itemWidth,
itemHeight,
itemArray[i].x,
GROUND_Y - itemArray[i].y,
itemWidth,
itemHeight
)) {
return true;
}
}
return false
}

// DRAWING
function draw() {

// Shake the screen if necessary.
var shakenCameraX = cameraX;
var shakenCameraY = cameraY;

if (gameMode === PAUSE_GAME_MODE) {
screenshake = false;
}

if (screenshake) {
shakenCameraX += (Math.random() - .5) * SCREENSHAKE_RADIUS;
shakenCameraY += (Math.random() - .5) * SCREENSHAKE_RADIUS;
}

// Draw the sky.
c.fillStyle = 'LightSkyBlue';
c.fillRect(0, 0, CANVAS_WIDTH, GROUND_Y - 40);

// Draw the background
var backgroundX = - (shakenCameraX % BACKGROUND_WIDTH);
if (backgroundImage.switching && backgroundX === 0) {
backgroundImage.numberToSwitch--
}
var currentImage = backgroundImage.imageNumber - 1;
var previousImage = backgroundImage.imageNumber - 2;
if (previousImage < 0) previousImage = backgroundImage.images.length - 1;
if (backgroundImage.switching && backgroundImage.numberToSwitch === 2) {
c.drawImage(backgroundImage.images[previousImage], backgroundX, -210);
c.drawImage(backgroundImage.images[previousImage], backgroundX + BACKGROUND_WIDTH, -210);
} else if (backgroundImage.switching && backgroundImage.numberToSwitch === 1) {
c.drawImage(backgroundImage.images[previousImage], backgroundX, -210);
c.drawImage(backgroundImage.images[currentImage], backgroundX + BACKGROUND_WIDTH, -210);
} else {
c.drawImage(backgroundImage.images[currentImage], backgroundX, -210);
c.drawImage(backgroundImage.images[currentImage], backgroundX + BACKGROUND_WIDTH, -210);
}

// Draw the ground.
c.fillStyle = 'ForestGreen';
c.fillRect(0, GROUND_Y - 40, CANVAS_WIDTH, CANVAS_HEIGHT - GROUND_Y + 40);

showHighScore(5, CANVAS_HEIGHT - HIGH_SCORE_HEIGHT + 45)

// Draw the Bushes
for (var i = 0; i < bushData.length; i++) {
c.drawImage(bushData[i].image, bushData[i].x - shakenCameraX, GROUND_Y - bushData[i].y - shakenCameraY);
}

// Draw the Start Screen
if (gameMode === START_GAME_MODE) {
c.fillStyle = 'Black'
c.fillRect(25, 220, 750, 150)
c.fillStyle = 'White'
c.font = '100px sans-serif';
c.textAlign = "center";
c.fillText("Press P to Start", 400, 325);
 
} else {
if (gameMode !== GAME_OVER_GAME_MODE) {
//Draw Highscore line
c.fillStyle = 'blue';
c.fillRect(retriveHighScore('pixel') - cameraX - coins.getCollected(300) + 250, 0, 5, CANVAS_HEIGHT);
}

//Draw the GoodItems
coins.draw(shakenCameraX, shakenCameraY);
hearts.draw(shakenCameraX, shakenCameraY);

//Draw the robots.
for (var i=0; i<robotData.length; i++) {
drawAnimatedSprite(robotData[i].x - shakenCameraX, robotData[i].y - shakenCameraY, robotData[i].frameNr, robotSpriteSheet);
}

// Draw the Nanonaut.
drawAnimatedSprite(nanonautX - shakenCameraX, nanonautY - shakenCameraY, nanonautFrameNr, nanonautSpriteSheet);

// Draw the coins collected
c.fillStyle = 'black';
c.font = '48px sans-serif';
c.textAlign = 'start';
c.fillText('Nano Coins: ' + coins.getCollected(1), 5, 40);

// Draw the distance the Nanonaut has travelled.
c.fillText(nanonautDistance.toFixed(0) + 'm', 5, 90);

// Draw the health bar.
c.fillStyle = 'red';
c.fillRect(400, 10, nanonautHealth / NANONAUT_MAX_HEALTH * 380, 20);
c.strokeStyle = 'red';
c.strokeRect(400, 10, 380, 20);

if (gameMode === PAUSE_GAME_MODE) {
c.fillStyle = 'Black'
c.fillRect(50, 250, 700, 100)
c.fillStyle = 'White'
c.font = '75px sans-serif';
c.textAlign = "center";
c.fillText("Press P to Resume", 400, 325);
}

if (gameMode == GAME_OVER_GAME_MODE) {
// If the game is over, draw "GAME OVER".
c.fillStyle = 'black';
c.textAlign = "center";
c.font = '96px sans-serif';
c.fillText('GAME OVER', 400, 300);
c.font = '48px sans-serif';
c.fillText('Final Distance: ' + totalNanonautDistance.toFixed(0) + 'm', 400, 365);
checkHighScore(totalNanonautDistance.toFixed(0));
showHighScore(5, CANVAS_HEIGHT - HIGH_SCORE_HEIGHT + 45);
}
}
}

//Draw Animated Sprite
function drawAnimatedSprite(screenX, screenY, frameNr, spriteSheet) {
var spriteSheetRow = Math.floor(frameNr / spriteSheet.nrFramesPerRow);
var spriteSheetColumn = frameNr % spriteSheet.nrFramesPerRow;
var spriteSheetX = spriteSheetColumn * spriteSheet.spriteWidth
var spriteSheetY = spriteSheetRow * spriteSheet.spriteHeight;
c.drawImage(
spriteSheet.image,
spriteSheetX, spriteSheetY,
spriteSheet.spriteWidth, spriteSheet.spriteHeight, screenX, screenY,
spriteSheet.spriteWidth, spriteSheet.spriteHeight
);
}

</script>
<audio id="gameMusic" loop>
  <source src="music/434856__emceeciscokid__retro-last-level-video-game-loop.wav" type="audio/wav">
</audio>
<audio id="gameoverSoundEffect">
  <source src="music/318415__jalastram__retro-game-sounds-sfx-144.wav" type="audio/wav">
</audio>
</body>
</html>